import{a as kt}from"./chunk-4RWDIW3R.js";import{a as St}from"./chunk-P5MX555A.js";import{a as At}from"./chunk-XVUFOYT7.js";import{a as wt}from"./chunk-LJ5LN32T.js";import{a as y}from"./chunk-C7XZ7IYY.js";import{B as gt,Ea as vt,Wa as Mt,X as bt,Ya as Pt,c as it,e as st,f as lt,g as ct,j as ut,ja as Dt,m as mt,na as yt,o as ht,oa as Ct,p as dt,r as pt,y as ft}from"./chunk-HSKCSBWS.js";import"./chunk-XX3OU7O5.js";import"./chunk-P5LOYQB2.js";import"./chunk-HEI3NBOD.js";import{l as nt,m as ot}from"./chunk-KV5YFX3I.js";import"./chunk-FPPZ4BUR.js";import"./chunk-QHBPP6FM.js";import{B as H,Fc as w,Gc as et,Tc as at,Wb as I,Xb as v,Yb as M,Zb as A,aa as T,cb as E,fa as F,hb as Q,jd as rt,m as $,na as X,nc as L,oa as z,qa as q,ra as U,rb as Z,va as K,w as G,xb as tt}from"./chunk-7GBT3Z6V.js";import{a as D,e as h,f as S}from"./chunk-ZOGHMS73.js";var R=class R{constructor(){}processDataForChart(t,e){if(!t||t.length===0)return this.getEmptyChartData(e);switch(e){case"Day":return this.processDayData(t);case"Month":return this.processMonthData(t);case"Year":return this.processYearData(t);default:return this.processMonthData(t)}}processDayData(t){let e=new Date,a=e.getHours(),r=new Array(24).fill(0);t.filter(m=>new Date(m.fecha_creacion)<=e).forEach(m=>{let P=new Date(m.fecha_creacion).getHours();P<=a&&(r[P]+=m.energia_acumulada_calc)});let n=r.map((m,p)=>p<=a?m:0),i=Array.from({length:24},(m,p)=>`${p.toString().padStart(2,"0")}:00`),l=n.slice(0,a+1),u=[...this.calculateProjection(l,a+1),...new Array(24-(a+1)).fill(0)],c=this.calculateBEP(l),s=n.slice(0,a+1).reduce((m,p)=>m+p,0);return{labels:i,currentData:n,projectionData:u,bepData:c,totalConsumption:s}}processMonthData(t){let e=new Date,a=e.getDate(),r=new Date(e.getFullYear(),e.getMonth()+1,0).getDate(),o=new Array(r).fill(0),n=new Array(r).fill(0);t.forEach(g=>{let b=new Date(g.fecha_creacion).getDate()-1;b>=0&&b<a&&(o[b]+=g.energia_acumulada_calc,n[b]++)});let i=o.map((g,C)=>C<a?n[C]>0?g:null:0),u=[...this.fillGapsWithInterpolation(i.slice(0,a)),...new Array(r-a).fill(0)],c=e.getMonth()+1,s=Array.from({length:r},(g,C)=>`${(C+1).toString().padStart(2,"0")}/${c.toString().padStart(2,"0")}`),m=this.calculateProjection(u,r),p=this.calculateBEP(u),P=u.reduce((g,C)=>g+C,0);return{labels:s,currentData:u,projectionData:m,bepData:p,totalConsumption:P}}processYearData(t){let e=new Date,a=e.getMonth(),r=new Array(12).fill(0);t.filter(s=>new Date(s.fecha_creacion)<=e).forEach(s=>{let p=new Date(s.fecha_creacion).getMonth();p<=a&&(r[p]+=s.energia_acumulada_calc)});let n=r.map((s,m)=>m<=a?s:0),i=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],l=this.calculateProjection(n,12),u=this.calculateBEP(n),c=n.reduce((s,m)=>s+m,0);return{labels:i,currentData:n,projectionData:l,bepData:u,totalConsumption:c}}calculateProjection(t,e){let a=t.filter(l=>l!=null&&l>0);if(a.length<2)return new Array(e).fill(0);let r=a.map((l,u)=>u),{slope:o,intercept:n}=this.calculateLinearRegression(r,a),i=[];for(let l=0;l<e;l++){let u=o*l+n;i.push(Math.max(0,u))}return i}calculateLinearRegression(t,e){let a=t.length,r=t.reduce((c,s)=>c+s,0),o=e.reduce((c,s)=>c+s,0),n=t.reduce((c,s,m)=>c+s*e[m],0),i=t.reduce((c,s)=>c+s*s,0),l=(a*n-r*o)/(a*i-r*r),u=(o-l*r)/a;return{slope:l,intercept:u}}calculateBEP(t){let e=t.filter(r=>r!=null&&r>0);if(e.length===0)return new Array(t.length).fill(5e3);let a=e.reduce((r,o)=>r+o,0)/e.length;return new Array(t.length).fill(Math.round(a*1.2))}fillGapsWithInterpolation(t){let e=[...t],a=t.map((r,o)=>r!==null?o:-1).filter(r=>r!==-1);if(a.length===0)return new Array(t.length).fill(0);if(a.length===1){let r=t[a[0]];return t.map(o=>o!==null?o:r)}for(let r=0;r<e.length;r++)if(e[r]===null){let o=-1;for(let i=r-1;i>=0;i--)if(e[i]!==null){o=i;break}let n=-1;for(let i=r+1;i<e.length;i++)if(e[i]!==null){n=i;break}if(o!==-1&&n!==-1){let i=e[o],l=e[n],u=(r-o)/(n-o);e[r]=i+(l-i)*u}else o!==-1?e[r]=e[o]:n!==-1?e[r]=e[n]:e[r]=0}return e}getEmptyChartData(t){let e,a;switch(t){case"Day":e=24,a=Array.from({length:24},(n,i)=>`${i.toString().padStart(2,"0")}:00`);break;case"Month":let r=new Date;e=new Date(r.getFullYear(),r.getMonth()+1,0).getDate();let o=r.getMonth()+1;a=Array.from({length:e},(n,i)=>`${(i+1).toString().padStart(2,"0")}/${o.toString().padStart(2,"0")}`);break;case"Year":e=12,a=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];break;default:e=12,a=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"]}return{labels:a,currentData:new Array(e).fill(0),projectionData:new Array(e).fill(0),bepData:new Array(e).fill(5e3),totalConsumption:0}}};R.\u0275fac=function(e){return new(e||R)},R.\u0275prov=T({token:R,factory:R.\u0275fac,providedIn:"root"});var j=R;var N=class N{constructor(){this.dayData1=[9e3,8e3,7e3,5e3,4e3,3e3,2e3,1e3,1e3,1200,1400,1600,1800,2500,2600,2800,2550,2900,3e3,3800,2400,3560];this.dayData3=Array(24).fill(3e3);this.monthData1=[400,450,430,440,460,435,422,468,420,600];this.monthData3Value=500;this.yearData1=[3e3,4800,5600,3200,4560,5100,3900,3800,2400,3560,5e3,4e3];this.yearData3=Array(12).fill(5e3);this.mainChart={type:"line"};this.initMainChart("Month")}random(t,e){return Math.floor(Math.random()*(e-t+1)+t)}getDaysInCurrentMonth(){let t=new Date,e=t.getFullYear(),a=t.getMonth()+1;return new Date(e,a,0).getDate()}calculateLinearRegression(t,e){let a=t.length,r=t.reduce((c,s)=>c+s,0),o=e.reduce((c,s)=>c+s,0),n=t.reduce((c,s,m)=>c+s*e[m],0),i=t.reduce((c,s)=>c+s*s,0),l=(a*n-r*o)/(a*i-r*r),u=(o-l*r)/a;return{slope:l,intercept:u}}generateRegressionProjection(t,e,a="Month"){let r=t.length;a==="Day"?r=Math.min(12,t.length):a==="Month"?r=Math.min(15,t.length):a==="Year"&&(r=Math.min(10,t.length));let o=t.slice(0,r),n=o.map((c,s)=>s),{slope:i,intercept:l}=this.calculateLinearRegression(n,o),u=[];for(let c=0;c<e;c++){let s=i*c+l;c<r,u.push(Math.max(0,s))}return u}initMainChart(t="Month"){let e=y("--cui-success")??"#4dbd74",a=y("--cui-info")??"#20a8d8",r=`rgba(${y("--cui-info-rgb")}, .1)`,o=y("--cui-danger")??"#f86c6b",n,i,l;t==="Day"?(n=this.dayData1,i=this.dayData3,l=24):t==="Month"?(n=this.monthData1,l=this.getDaysInCurrentMonth(),i=Array(l).fill(this.monthData3Value)):t==="Year"?(n=this.yearData1,i=this.yearData3,l=12):(n=this.yearData1,i=this.yearData3,l=12);let u=n;t==="Month"&&n.length<l&&(u=[...n,...Array(l-n.length).fill(null)]);let c=this.generateRegressionProjection(n,l,t);this.mainChart.Data1=u,this.mainChart.Data2=c,this.mainChart.Data3=i;let s=[];if(t==="Day")s=Array.from({length:24},(d,W)=>`${W.toString().padStart(2,"0")}:00`);else if(t==="Month"){let W=new Date().getMonth()+1,_t=this.getDaysInCurrentMonth();s=Array.from({length:_t},(Bt,Lt)=>`${(Lt+1).toString().padStart(2,"0")}/${W.toString().padStart(2,"0")}`)}else if(t==="Year")s=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];else{let d=["Lunes","Martes","Mi\xE9rcoles","Jueves","Viernes","S\xE1bado","Domingo"];s=d.concat(d,d,d)}let m=[{backgroundColor:r,borderColor:a,pointHoverBackgroundColor:a,borderWidth:2,fill:!0},{backgroundColor:"transparent",borderColor:"#ffc107",pointHoverBackgroundColor:"#ffc107",borderWidth:2,borderDash:[20,5]},{backgroundColor:"transparent",borderColor:o||"#f86c6b",pointHoverBackgroundColor:o,borderWidth:1,borderDash:[8,5]}],p=[D({data:this.mainChart.Data1,label:"Current"},m[0]),D({data:this.mainChart.Data2,label:"Projection"},m[1]),D({data:this.mainChart.Data3,label:"BEP"},m[2])],P={legend:{display:!1},tooltip:{callbacks:{labelColor:d=>({backgroundColor:d.dataset.borderColor})}}},g=[...this.mainChart.Data1.filter(d=>d!==null&&!isNaN(d)),...this.mainChart.Data2.filter(d=>d!==null&&!isNaN(d)),...this.mainChart.Data3.filter(d=>d!==null&&!isNaN(d))],b=Math.max(...g)*1.1,Et=this.getScales(b),It={maintainAspectRatio:!1,plugins:P,scales:Et,elements:{line:{tension:.4},point:{radius:0,hitRadius:10,hoverRadius:4,hoverBorderWidth:3}}};this.mainChart.type="line",this.mainChart.options=It,this.mainChart.data={datasets:p,labels:s}}getCurrentMaxValue(){let t=[...this.mainChart.Data1.filter(a=>a!==null&&!isNaN(a)),...this.mainChart.Data2.filter(a=>a!==null&&!isNaN(a)),...this.mainChart.Data3.filter(a=>a!==null&&!isNaN(a))],e=Math.max(...t);return e>0?e*1.1:250}updateChartWithApiData(t){this.mainChart.Data1=t.currentData,this.mainChart.Data2=t.projectionData,this.mainChart.Data3=t.bepData,this.updateChartConfig(t.labels,t.currentData,t.projectionData,t.bepData)}updateChartConfig(t,e,a,r){let o=y("--cui-success")??"#4dbd74",n=y("--cui-info")??"#20a8d8",i=`rgba(${y("--cui-info-rgb")}, .1)`,l=y("--cui-danger")??"#f86c6b",u=[{backgroundColor:i,borderColor:n,pointHoverBackgroundColor:n,borderWidth:2,fill:!0},{backgroundColor:"transparent",borderColor:"#ffc107",pointHoverBackgroundColor:"#ffc107",borderWidth:2,borderDash:[20,5]},{backgroundColor:"transparent",borderColor:l||"#f86c6b",pointHoverBackgroundColor:l,borderWidth:1,borderDash:[8,5]}],c=[D({data:e,label:"Consumo"},u[0]),D({data:a,label:"Proyeccion"},u[1]),D({data:r,label:"Limite Establecido"},u[2])],s={legend:{display:!1},tooltip:{callbacks:{labelColor:b=>({backgroundColor:b.dataset.borderColor})}}},m=[...e,...a,...r].filter(b=>b!==null&&!isNaN(b)),P=Math.max(...m)*1.1,g=this.getScales(P),C={maintainAspectRatio:!1,plugins:s,scales:g,elements:{line:{tension:.4},point:{radius:0,hitRadius:10,hoverRadius:4,hoverBorderWidth:3}}};this.mainChart.type="line",this.mainChart.options=C,this.mainChart.data={datasets:c,labels:t}}getCurrentConsumption(t="Month"){if(this.mainChart.Data1)return this.mainChart.Data1.reduce((a,r)=>a+(r||0),0);let e;return t==="Day"?e=this.dayData1:t==="Month"?e=this.monthData1:t==="Year"?e=this.yearData1:e=this.monthData1,e.reduce((a,r)=>a+(r||0),0)}getScales(t){let e=t??this.getCurrentMaxValue(),a=y("--cui-border-color-translucent"),r=y("--cui-body-color");return{x:{grid:{color:a,drawOnChartArea:!1},ticks:{color:r}},y:{border:{color:a},grid:{color:a},max:e,beginAtZero:!0,ticks:{color:r,maxTicksLimit:5,stepSize:Math.ceil(e/5)}}}}};N.\u0275fac=function(e){return new(e||N)},N.\u0275prov=T({token:N,factory:N.\u0275fac,providedIn:"any"});var B=N;var Tt=()=>({"marginTop.px":40});function jt(Nt,t){Nt&1&&(v(0,"div",19),A(1,"i",20),w(2," Cargando datos... "),M())}var J,Y,x,k,f,O,V,_=class _{constructor(){this.trafficPeriodLabel="";this.isLoadingData=!1;this.currentApiData=[];this.previousApiData=[];S(this,J,F(U));S(this,Y,F(q));S(this,x,F(Q));S(this,k,F(B));S(this,f,F(At));S(this,O,F(j));this.users=[{name:"Yiorgos Avraamu",state:"New",registered:"Jan 1, 2021",country:"Us",usage:50,period:"Jun 11, 2021 - Jul 10, 2021",payment:"Mastercard",activity:"10 sec ago",avatar:"./assets/images/avatars/1.jpg",status:"success",color:"success"},{name:"Avram Tarasios",state:"Recurring ",registered:"Jan 1, 2021",country:"Br",usage:10,period:"Jun 11, 2021 - Jul 10, 2021",payment:"Visa",activity:"5 minutes ago",avatar:"./assets/images/avatars/2.jpg",status:"danger",color:"info"},{name:"Quintin Ed",state:"New",registered:"Jan 1, 2021",country:"In",usage:74,period:"Jun 11, 2021 - Jul 10, 2021",payment:"Stripe",activity:"1 hour ago",avatar:"./assets/images/avatars/3.jpg",status:"warning",color:"warning"},{name:"En\xE9as Kwadwo",state:"Sleep",registered:"Jan 1, 2021",country:"Fr",usage:98,period:"Jun 11, 2021 - Jul 10, 2021",payment:"Paypal",activity:"Last month",avatar:"./assets/images/avatars/4.jpg",status:"secondary",color:"danger"},{name:"Agapetus Tade\xE1\u0161",state:"New",registered:"Jan 1, 2021",country:"Es",usage:22,period:"Jun 11, 2021 - Jul 10, 2021",payment:"ApplePay",activity:"Last week",avatar:"./assets/images/avatars/5.jpg",status:"success",color:"primary"},{name:"Friderik D\xE1vid",state:"New",registered:"Jan 1, 2021",country:"Pl",usage:43,period:"Jun 11, 2021 - Jul 10, 2021",payment:"Amex",activity:"Yesterday",avatar:"./assets/images/avatars/6.jpg",status:"info",color:"dark"}];this.mainChart={type:"line"};this.mainChartRef=K(void 0);S(this,V,rt(()=>{this.mainChartRef()&&this.setChartStyles()}));this.chart=[];this.trafficRadioGroup=new ct({trafficRadio:new ut("Month")});this.currentPeriod="Month";this.currentConsumption=0}ngOnInit(){this.currentPeriod="Month",this.updateTrafficPeriodLabel("Month"),this.updateChartOnColorModeChange(),this.loadDataForPeriod("Month")}initCharts(){this.mainChartRef()?.stop(),this.mainChart=h(this,k).mainChart}setTrafficPeriod(t){this.currentPeriod=t,this.trafficRadioGroup.setValue({trafficRadio:t}),this.updateTrafficPeriodLabel(t),this.loadDataForPeriod(t)}loadDataForPeriod(t){this.isLoadingData=!0;let e,a;switch(t){case"Day":e=h(this,f).getDayFilter(),a=h(this,f).getPreviousDayFilter();break;case"Month":e=h(this,f).getMonthFilter(),a=h(this,f).getPreviousMonthFilter();break;case"Year":e=h(this,f).getYearFilter(),a=h(this,f).getPreviousYearFilter();break;default:e=h(this,f).getMonthFilter(),a=h(this,f).getPreviousMonthFilter()}let r=h(this,f).getFilteredData(e),o=h(this,f).getFilteredData(a);G([r,o]).pipe(H(n=>(console.error("Error al cargar datos de la API:",n),h(this,k).initMainChart(t),this.initCharts(),this.updateConsumption(),this.isLoadingData=!1,$([null,null])))).subscribe(([n,i])=>{if(n&&n.success){this.currentApiData=n.data,this.previousApiData=i&&i.success?i.data:[];let l=h(this,O).processDataForChart(n.data,t);h(this,k).updateChartWithApiData(l),this.initCharts(),this.currentConsumption=l.totalConsumption}this.isLoadingData=!1})}updateConsumption(){this.currentConsumption=h(this,k).getCurrentConsumption(this.currentPeriod)}updateTrafficPeriodLabel(t){let e=new Date;if(t==="Day"){let a=String(e.getDate()).padStart(2,"0"),r=String(e.getMonth()+1).padStart(2,"0"),o=e.getFullYear();this.trafficPeriodLabel=`Hoy ${a}/${r}/${o}`}else if(t==="Month"){let r=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][e.getMonth()],o=e.getFullYear();this.trafficPeriodLabel=`${r} ${o}`}else if(t==="Year"){let a=e.getFullYear();this.trafficPeriodLabel=`Enero - Diciembre ${a}`}else this.trafficPeriodLabel=""}handleChartRef(t){t&&this.mainChartRef.set(t)}updateChartOnColorModeChange(){let t=h(this,x).listen(h(this,Y).documentElement,"ColorSchemeChange",()=>{this.setChartStyles()});h(this,J).onDestroy(()=>{t()})}setChartStyles(){this.mainChartRef()&&setTimeout(()=>{let t=D({},this.mainChart.options),e=h(this,k).getScales();this.mainChartRef().options.scales=D(D({},t.scales),e),this.mainChartRef().update()})}};J=new WeakMap,Y=new WeakMap,x=new WeakMap,k=new WeakMap,f=new WeakMap,O=new WeakMap,V=new WeakMap,_.\u0275fac=function(e){return new(e||_)},_.\u0275cmp=Z({type:_,selectors:[["ng-component"]],decls:27,vars:15,consts:[[3,"currentPeriod","currentConsumption","currentApiData","previousApiData"],[1,"my-4"],["sm","5"],["id","traffic",1,"card-title","mb-0"],[1,"small","text-body-secondary"],["class","small text-info mt-1",4,"ngIf"],["sm","7",1,"d-none","d-md-block"],["cButton","","color","primary","aria-label","Download",1,"float-end"],["cIcon","","name","cilCloudDownload"],[3,"formGroup"],["role","group",1,"float-end","me-3"],["formControlName","trafficRadio","type","radio","value","Day","id","dayRadio",1,"btn-check"],["cButton","","cFormCheckLabel","","color","secondary","variant","outline","for","dayRadio",3,"click"],["formControlName","trafficRadio","type","radio","value","Month","id","radioMonth",1,"btn-check"],["cButton","","cFormCheckLabel","","color","secondary","variant","outline","for","radioMonth",3,"click"],["formControlName","trafficRadio","type","radio","value","Year","id","radioYear",1,"btn-check"],["cButton","","cFormCheckLabel","","color","secondary","variant","outline","for","radioYear",3,"click"],[3,"chartRef","data","height","ngStyle","options","type"],[3,"apiData","isLoading"],[1,"small","text-info","mt-1"],[1,"fa","fa-spinner","fa-spin"]],template:function(e,a){e&1&&(A(0,"app-widgets-dropdown",0),v(1,"c-card",1)(2,"c-card-body")(3,"c-row")(4,"c-col",2)(5,"h4",3),w(6,"Consumo Electrico"),M(),v(7,"div",4),w(8),M(),tt(9,jt,3,0,"div",5),M(),v(10,"c-col",6)(11,"button",7),X(),A(12,"svg",8),M(),z(),v(13,"form",9)(14,"c-button-group",10),A(15,"input",11),v(16,"label",12),L("click",function(){return a.setTrafficPeriod("Day")}),w(17," Dia "),M(),A(18,"input",13),v(19,"label",14),L("click",function(){return a.setTrafficPeriod("Month")}),w(20," Mes "),M(),A(21,"input",15),v(22,"label",16),L("click",function(){return a.setTrafficPeriod("Year")}),w(23," A\xF1o "),M()()()()(),v(24,"c-chart",17),L("chartRef",function(o){return a.handleChartRef(o)}),w(25," Main chart "),M()()(),A(26,"app-smart-tables-basic-example",18)),e&2&&(I("currentPeriod",a.currentPeriod)("currentConsumption",a.currentConsumption)("currentApiData",a.currentApiData)("previousApiData",a.previousApiData),E(8),et(a.trafficPeriodLabel),E(),I("ngIf",a.isLoadingData),E(4),I("formGroup",a.trafficRadioGroup),E(11),I("data",a.mainChart.data)("height",300)("ngStyle",at(14,Tt))("options",a.mainChart.options)("type",a.mainChart.type),E(2),I("apiData",a.currentApiData)("isLoading",a.isLoadingData))},dependencies:[kt,yt,Ct,Pt,Mt,bt,gt,ft,mt,it,ht,st,lt,dt,pt,Dt,vt,wt,ot,nt,St],styles:["[_nghost-%COMP%]   .legend[_ngcontent-%COMP%]   small[_ngcontent-%COMP%]{font-size:x-small}"]});var Rt=_;export{Rt as DashboardComponent};
